{% extends theme("admin_master.html") %}

{% block title %} - Administration{% endblock %}

{% block content %}
    <div id="wrapper">
        {% include theme("admin_menu.html") %}
        <div id="page-wrapper">
            <div id="edit-window">
                <div class="row">
                    <div class="col-lg-12">
                        <h1 class="page-header">{{ action }} {{ content_type }}</h1>
                        <form role="form" method="POST">
                            <div class="form-group">
                                <label for="title">Title</label>
                                <input class="form-control" id="title" name="title" value="{{ content.title  }}" />
                            </div>
                            <div class="form-group row">
                                <div class="col-xs-4">
                                    <label for="content-parser">Content Type</label>
                                    <select class="form-control" id="content-parser" name="content_parser">
                                        <option value="markdown"{% if content.parser == 'markdown' %} selected{% endif %}>Markdown</option>
                                        <option value="textile"{% if content.parser == 'textile' %} selected{% endif %}>Textile</option>
                                        <option value="html"{% if content.parser == 'html' %} selected{% endif %}>HTML</option>
                                        <option value="mediawiki"{% if content.parser == 'mediawiki' %} selected{% endif %}>Wiki</option>
                                    </select>
                                </div>
                                <div class="col-xs-4 datetime-field">
                                    <label for="created-on">Created</label>
                                    <input class="form-control" id="created-on" name="created_on" value="{{ content.human_created_on() }}" />
                                </div>
                                <div class="col-xs-2">
                                    <br />
                                    <div class="checkbox">
                                        <label for="published">Published</label>
                                        <input id="published" type="checkbox" value="1"{% if content.published %} checked="checked"{% endif %} />
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="body">Body</label>
                                <div id="body" style="border-radius: 5px; width: 100%; height: 100%; min-height: 500px;">{{ content.body }}</div>
                            </div>
                            <button id="save" class="btn btn-default">Save</button>
                            <button id="preview" class="btn btn-default">Preview</button>
                        </form>
                    </div>
                    <!-- /.col-lg-12 -->
                </div>
                <!-- /.row -->
            </div>
            <!-- /#edit-window-->
            <div id="preview-div" style="display: none;">
                <button class="btn btn-danger btn-small" id="close-preview" style="float: right; margin-top: 5px;">&times;</button>
                <iframe id="preview-iframe" src="about:blank" style="border: 0px; clear: both; margin-top: 10px;"></iframe>
            </div>
        </div>
        <!-- /#page-wrapper -->
    </div>
    <!-- /#wrapper -->
{% endblock content %}

{% block javascript %}
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/ace.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/mode-textile.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/theme-monokai.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/mode-text.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/mode-markdown.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/mode-html.js"></script>
<script type="text/javascript">
    var editor = ace.edit("body");
    editor.setTheme("ace/theme/monokai");
    {% if content_parser == "mediawiki" %}
        editor.getSession().setMode("ace/mode/text");
    {% else %}
        editor.getSession().setMode("ace/mode/{{ content.parser }}");
    {% endif %}
    $("#content-parser").change(function() {
        var optionSelected = $("option:selected", this);
        var valueSelected = this.value;
        if (valueSelected !== "mediawiki") {
            editor.getSession().setMode("ace/mode/" + valueSelected);
        }
        else {
            editor.getSession().setMode("ace/mode/text");
        }
    });
    function save_content(showPreview) {
        body = editor.getValue();
        title = $('#title').val();
        content_parser = $('#content-parser').val();
        created_on = $('#created-on').val();
        published = $('#published').is(':checked');
        content_type = "{{ content.type }}";
        user_id = "{{ user.id }}";
        var submit = {
            'body': body,
            'title': title,
            'user_id': user_id,
            'parser': content_parser,
            'published': published,
            'created_on': created_on,
            'type': content_type
        };

        var editing = false;

        if (window.location.href.indexOf("edit") !== -1) {
            var url_parts = window.location.href.replace(/\/\s*$/,'').split('/');
            var index = url_parts.length - 1;
            submit.id = url_parts[index];
            editing = true;
        }

        $.post("/content_create",
            submit
        ).done(function( data ) {
            if (data.success === true && editing === false) {
                window.location.href = "/admin_pages/edit/" + data.id;
            }
            $.bootbar.show(data.messages[0], { autoDismiss: true });
            if (showPreview) {
                $("#preview-iframe").height($("#page-wrapper").height() - $("#navigation-bar").height());
                $("#preview-iframe").width($("#edit-window").width());
                $("#preview-iframe").attr("src", "/page/" + data.id);
                $("#preview-div").show();
                $("#edit-window").hide();
                window.scrollTo(0, 0);
            }
        });
    }
    $("#close-preview").click(function(e) {
        e.preventDefault();
        $("#preview-div").hide();
        $("#edit-window").show();
        $("#preview-iframe").height(0);
        $("#preview-iframe").width(0);
    });
    $("#preview").click(function(e) {
        e.preventDefault();
        save_content(true);
    });
    $("#save").click(function(e) {
        e.preventDefault();
        save_content();
    });
</script>
{% endblock javascript %}
