{% extends theme("admin_master.html") %}

{% block title %} - Administration{% endblock %}

{% block content %}
    <div id="wrapper">
        {% include theme("admin_menu.html") %}
        <div id="page-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header">{{ action }} {{ content_type }}</h1>
                    <form role="form">
                        <div class="form-group">
                            <label for="title">Title</label>
                            <input class="form-control" id="title" name="title" value="{{ title  }}" />
                        </div>
                        <div class="form-group">
                            <label for="content-parser">Content Type</label>
                            <select class="form-control" id="content-parser" name="content_parser">
                                <option value="markdown"{% if content_parser == 'markdown' %} selected{% endif %}>Markdown</option>
                                <option value="textile"{% if content_parser == 'textile' %} selected{% endif %}>Textile</option>
                                <option value="html"{% if content_parser == 'html' %} selected{% endif %}>HTML</option>
                                <option value="mediawiki"{% if content_parser == 'mediawiki' %} selected{% endif %}>Wiki</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="body">Body</label>
                            <div id="body" style="width: 100%; height: 100%; min-height: 500px;">{{ body }}</div>
                        </div>
                        <button id="save" class="btn btn-default">Save</button>
                        <button id="preview" class="btn btn-default">Preview</button>
                    </form>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /#page-wrapper -->

    </div>
    <!-- /#wrapper -->
{% endblock content %}

{% block javascript %}
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/ace.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/mode-textile.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/theme-monokai.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/mode-text.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/mode-markdown.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/mode-html.js"></script>
<script type="text/javascript">
    var editor = ace.edit("body");
    editor.setTheme("ace/theme/monokai");
    {% if content_parser == "mediawiki" %}
        editor.getSession().setMode("ace/mode/text");
    {% else %}
        editor.getSession().setMode("ace/mode/{{ content_parser }}");
    {% endif %}
    $("#content-parser").change(function() {
        var optionSelected = $("option:selected", this);
        var valueSelected = this.value;
        if (valueSelected !== "mediawiki") {
            editor.getSession().setMode("ace/mode/" + valueSelected);
        }
        else {
            editor.getSession().setMode("ace/mode/text");
        }
    });

    $("#save").click(function(e) {
        e.preventDefault();
        body = editor.getValue();
        title = $('#title').val();
        content_parser = $('#content-parser').val();
        content_type = "{{ content_type }}";
        user_id = "{{ user.id }}";
        var submit = {
            'body': body,
            'title': title,
            'user_id': user_id,
            'parser': content_parser,
            'type': content_type
        };

        var editing = false;

        if (window.location.href.indexOf("edit") !== -1) {
            var url_parts = window.location.href.replace(/\/\s*$/,'').split('/');
            var index = url_parts.length - 1;
            submit.id = url_parts[index];
            editing = true;
        }

        $.post("/content_create",
            submit
        ).done(function( data ) {
            if (data.success === true && editing === false) {
                window.location.href = "/admin_pages/edit/" + data.id;
            }
            $.bootbar.show(data.messages[0], { autoDismiss: true });
        });
    });
</script>
{% endblock javascript %}
